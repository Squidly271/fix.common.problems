Menu="Utilities"
Icon="FixIt.png"
Title="Fix Common Problems"
---
<?
###############################################################
#                                                             #
# Fix Common Problems copyright 2015-2016, Andrew Zawadzki    #
#                                                             #
###############################################################

$plugin = "fix.common.problems";

$settings = json_decode(@file_get_contents("/boot/config/plugins/fix.common.problems/settings.json"),true);

if ( ! $settings['notifications'] ) { $settings['notifications'] = "all"; }
if ( ! $settings['frequency'] ) { $settings['frequency'] = "disabled"; }
if ( ! $settings['disableSpinUp'] ) { $settings['disableSpinUp'] = "false"; }
if ( ! $settings['hacksPerDay'] ) { $settings['hacksPerDay'] = 10; }

if ( is_file("/tmp/fix.common.problems/troubleshoot") ) { $troubleshoot = true; }

?>
<script>

var URL = "/plugins/<?=$plugin?>/include/fixExec.php";

function myAlert(description,textdescription,textimage,imagesize, outsideClick, showCancel, showConfirm, alertType) {
  if ( !outsideClick ) outsideClick = false;
  if ( !showCancel )   showCancel = false;
  if ( !showConfirm )  showConfirm = false;
  if ( imagesize == "" ) { imagesize = "80x80"; }
   
  swal({
    title: description,
    text: textdescription,
    imageUrl: textimage,
    imageSize: imagesize,
    allowOutsideClick: outsideClick,
    showConfirmButton: showConfirm,
    showCancelButton: showCancel,
    type: alertType,
    html: true
  });
}

function myCloseAlert() {
  swal.close();
}

function ignoreError(error,type,button) {
  swal({
    title: "Ignore "+type+"?",
    text: "Are you sure you want to ignore this "+type+":<br><font color='red'><b>"+error+"</b></font><br>As a <em>general rule</em> this is not recommended unless you are absolutely sure about this",
    showConfirmButton: true,
    showCancelButton: true,
    closeOnConfirm: false,
    type: "warning",
    html: true
  },
  function() {
    $.post(URL,{action:"ignoreError",error:error});
      swal({
        title: "Ignored!",
        text: "On future scans, <font color='green'><b>"+error+"</b></font> will not generate a "+type+".  This will still however be logged in the syslog.",
        showConfirmButton: true,
        showCancelButton: false,
        closeOnConfirm: true,
        html: true,
        type: "success"
      });
      $("#"+button).prop("disabled",true);
      $("#"+button).prop("value","Ignored");
  });
}

function readdError(error,button) {
  swal({
    title: "Readd This Error?",
    text: "Are you sure you want to begin scanning for this error again:<br><font color='red'><b>"+error+"</b></font>",
    showConfirmButton: true,
    showCancelButton: true,
    closeOnConfirm: false,
    type: "warning",
    html: true
  },
  function() {
    $.post(URL,{action:"readdError",error:error});
      swal({
        title: "Ignored!",
        text: "On future scans, <font color='red'><b>"+error+"</b></font> will generate either a warning or an error",
        showConfirmButton: true,
        showCancelButton: false,
        closeOnConfirm: true,
        html: true,
        type: "success"
      });
      $("#"+button).prop("disabled",true);
      $("#"+button).prop("value","Monitored");
    });
}

function readdAll() {
  swal({
    title: "Re-Add All Errors?",
    text: "Are you sure you want to set all of the current ignored errors back to generating errors / warnings?",
    showConfirmButton: true,
    showCancelButton: true,
    closeOnConfirm: false,
    type: "warning",
    html: true
  },
  function() {
    $.post(URL,{action:"readdAll"});
      swal({
        title: "Re-Added",
        text: "On future scans, all errors / warnings found will generate an error / warning",
        showConfirmButton: true,
        showCancelButton: false,
        closeOnConfirm: true,
        html: true,
        type: "success"
      });
  });
}

function troubleshoot() {
  swal({
    title: "Troubleshooting Mode",
    text: "This is a special mode used generally to troubleshoot random lockups, resets, etc.<br><br>When running in this mode, a subset of the tests are performed every <b>10 minutes</b>, the syslog is <b>continually</b> captured to the flash drive, and a diagnostics dump is performed every <b>30 minutes</b><br><br><font color='red'>When posting for help in the forums, you should include both the diagnostics file and the syslog.txt file located within /boot/logs</font>.  <b>It will also be extremely helpful to include a screenshot (use your phone) of what appears on the local monitor when the crash / lockup occurs</b><br><br>Once started, the only way to abort this mode is by <b>restarting</b> your server",
    showConfirmButton: true,
    showCancelButton: true,
    html: true,
    type: "warning",
    closeOnConfirm: false
  }, function() {
    $.post(URL,{action:'troubleshoot'});
    $("#troubleshoot").val("Troubleshooting running");
    $("#troubleshoot").prop("disabled",true);
    swal({
      title: "Troubleshooting Started",
      text: "When uploading your diagnostics for review on the unRaid forums, remember to include <b>/logs/syslog.txt</b> from the flash drive, as it may contain further information that will not be present in the diagnostic files",
      html: true,
      showCancelButton: false,
      showConfirmButton: true,
      closeOnConfirm: true,
      type: "success"
    });
  });

}

function checkList() {
  openBox('/plugins/fix.common.problems/scripts/checkList.php',"What Is Checked?",550,550);
}


$(function() {
  $("#frequency").val("<?=$settings['frequency']?>");
  $("#notifications").val("<?=$settings['notifications']?>");
  $("#disableSpinUp").val("<?=$settings['disableSpinUp']?>");
  $("#hacksPerDay").val("<?=$settings['hacksPerDay']?>");
  

  if ( "<?=$troubleshoot?>" ) {
    $("#troubleshoot").prop("disabled",true);
    $("#troubleshoot").val("Troubleshooting running");
  }
  
  if ($('.adsitem').length==0 || $('.adsitem').css('display')=='none') {
    myAlert("Ad Blocker Detected","Ad blockers under certain circumstances can interfere with the displaying of information from unRaid.  You will need to &quot;white-list&quot; your server with your ad blocker program.","","",false,false,true,"error");   
  } else {
    myCloseAlert();
  }
  $.post(URL,{action:'getTimeStamp'},function(data) {
    if (data) {
      if ( data == "*" ) {
        rescan();
      } else {
        $.post(URL,{action:'displayErrors'}, function(errors) {
          if (errors) {
            $("#settings").html(errors);
          }
        });
        $("#timestamp").html(data);
      }
    }
  });
});

function rescan() {
  myAlert("Scanning","Now Scanning your system for common problems.  This may take a minute.  All of your drives will spin up during this process.","","",false,false,false,"warning");
  $.post(URL,{action:'scan'},function(data) {
    if (data) {
      myCloseAlert();
      $("#settings").html(data);
      $.post(URL,{action:'getTimeStamp'}, function(timestamp) {
        if (timestamp) {
          $("#timestamp").html(timestamp);
        }
      });

    }
  });
}
function acknowledgeUncleanReboot(button)
{
  $.post(URL,{action:'acknowledgeUncleanReboot'});
  $("#"+button).hide();
}

function enableApply() {
  $("#applyButton").prop("disabled",false);
}

function apply() {
  var frequency = $("#frequency").val();
  var notifications = $("#notifications").val();
  var disableSpinUp = $("#disableSpinUp").val();
  var hacksPerDay = $("#hacksPerDay").val();
  
  $.post(URL,{action:'apply',frequency:frequency,notifications:notifications,disableSpinUp:disableSpinUp,hacksPerDay:hacksPerDay});
  $("#applyButton").prop("disabled",true);
}

</script>
<div  style='width:40%;align:left;'>
<table>
<tr>
  <td><b>Frequency to run background checks</b></td>
  <td><select id='frequency' onchange='enableApply();'>
        <option value='disabled'>Disabled</option>
        <option value='hourly'>Hourly</option>
        <option value='daily'>Daily</option>
        <option value='weekly'>Weekly</option>
        <option value='monthly'>Monthly</option>
      </select>
  </td>
</tr>
<tr>
  <td><b>Send notifications on errors?</b></td>
  <td><select id='notifications' onchange='enableApply();'>
        <option value='disabled'>Disabled</option>
        <option value='all'>All errors / Warnings</option>
        <option value='errors'>Errors Only</option>
      </select>
  </td>
</tr>
<tr>
  <td><b>Avoid spinning up disks for tests?</b></td>
  <td><select id='disableSpinUp' onchange='enableApply();'>
    <option value='false'>Always perform tests (recommended)</option>
    <option value='true'>Skip tests on spun down disks</option>
  </select></td>
</tr>
<tr>
  <td><b>Number of allowed invalid logins per day:</b></td>
  <td><input type='number' id='hacksPerDay' onchange='enableApply();'></td>
</tr>
</table>
</div>

> <b>Frequency to run background checks</b> - Set to how often you would like this plugin to automatically scan your system for errors and warnings.<br>
> <b>Send notifications on errors</b> determines under what circumstances the plugin will notify you through unRaid's notification system of any issues<br>
> <b>Avoid spinning up disks for tests</b> - Will try and avoid certain tests on disks (notably the write check) that unRaid thinks are currently spun down<br>
> <b>Number of allowed invalid logins per day</b> - This is the number of "grace" invalid logins allowed per day either via the local console or through SSH / Telnet (ie: you typed your password wrong)  This is used to determine if any hacking attempts are being made on your server<br>

<input type='button' id='applyButton' value='Apply' onclick='apply();' disabled><input type='button' value='Rescan' onclick='rescan();'><input type='button' onclick='done();' value='Done'><span style='float:right'><input type='button' id='troubleshoot' value='Troubleshooting Mode' onclick='troubleshoot();'></span><br><br>
> Troubleshooting mode will add start a process to continually save your syslog, automatically run diagnostics every half hour, and run a subset of these tests every ten minutes.  Useful for diagnosing random crashes, etc.

<center><b>Time of last scan: <span id='timestamp'></span></center>

<span id='settings'></span>

<center><input type='button' value='What is checked' onclick='checkList();'></center>

<center>
<b>For assistance with any of the errors / warnings displayed here, please post a new topic in <a href='http://lime-technology.com/forum/index.php?board=71.0' target='_blank'>General Support</a></b><br>
<b>For assistance with the plugin, including requests for additional checks, false positives, etc please post <a href='http://lime-technology.com/forum/index.php?topic=48972.0' target='_blank'>HERE</a></b>
</center>
<div class="adsitem"></div>